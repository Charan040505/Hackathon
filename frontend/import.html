<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inventory Analytics</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #f4f6f9;
      padding: 40px 0;
      font-family: 'Segoe UI', sans-serif;
    }
    .container {
      max-width: 960px;
    }
    .title {
      font-size: 28px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 30px;
      color: #2c3e50;
    }
    .alert {
      margin-bottom: 25px;
    }
    .chart-container {
      margin-bottom: 40px;
    }
    .table th {
      background-color: #007bff;
      color: white;
    }
    .btn-back {
      margin-top: 30px;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="title">üìä Inventory Summary by Category</div>

  <div id="lowStockAlert"></div>

  <div class="chart-container">
    <canvas id="quantityChart"></canvas>
  </div>

  <div class="chart-container">
    <canvas id="itemChart"></canvas>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>üìÇ Category</th>
          <th>üßæ Total Items</th>
          <th>üì¶ Total Quantity</th>
          <th>üí∞ Avg. Price (‚Çπ)</th>
        </tr>
      </thead>
      <tbody id="summaryTableBody"></tbody>
    </table>
  </div>

  <div class="text-center">
    <a href="dashboard.html" class="btn btn-secondary btn-back">‚¨ÖÔ∏è Back to Dashboard</a>
  </div>
</div>

<script>
  async function loadSummary() {
    try {
      const res = await fetch("http://localhost:5000/api/items/summary-by-category");
      const data = await res.json();

      const tableBody = document.getElementById("summaryTableBody");
      const categories = [];
      const totalItems = [];
      const totalQuantities = [];

      tableBody.innerHTML = "";

      data.forEach(item => {
        categories.push(item._id);
        totalItems.push(item.totalItems);
        totalQuantities.push(item.totalQuantity);

        tableBody.innerHTML += `
          <tr>
            <td>${item._id}</td>
            <td>${item.totalItems}</td>
            <td>${item.totalQuantity}</td>
            <td>‚Çπ${item.averagePrice}</td>
          </tr>
        `;
      });

      // Bar Chart for Quantity
      new Chart(document.getElementById('quantityChart'), {
        type: 'bar',
        data: {
          labels: categories,
          datasets: [{
            label: 'Total Quantity',
            data: totalQuantities,
            backgroundColor: '#3498db'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Total Quantity by Category'
            },
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });

      // Doughnut Chart for Items
      new Chart(document.getElementById('itemChart'), {
        type: 'doughnut',
        data: {
          labels: categories,
          datasets: [{
            label: 'Total Items',
            data: totalItems,
            backgroundColor: [
              '#e74c3c', '#f1c40f', '#2ecc71', '#9b59b6', '#1abc9c'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Item Count Distribution'
            }
          }
        }
      });

    } catch (error) {
      console.error("Failed to fetch summary:", error);
    }
  }

  async function checkLowStock() {
    try {
      const res = await fetch("http://localhost:5000/api/items/lowstock");
      const items = await res.json();
      const alertBox = document.getElementById("lowStockAlert");

      if (items.length > 0) {
        let message = `<div class="alert alert-warning" role="alert"><strong>‚ö†Ô∏è Low Stock Alert!</strong><br><ul>`;
        items.forEach(item => {
          message += `<li><strong>${item.name}</strong> (Qty: ${item.quantity}) in <em>${item.category}</em></li>`;
        });
        message += `</ul></div>`;
        alertBox.innerHTML = message;
      } else {
        alertBox.innerHTML = `<div class="alert alert-success" role="alert">‚úÖ All stock levels are healthy.</div>`;
      }

    } catch (err) {
      console.error("Error checking low stock:", err);
    }
  }

  window.onload = () => {
    loadSummary();
    checkLowStock();
  };
</script>

</body>
</html>
